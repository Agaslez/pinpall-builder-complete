Struktura repo
stefano/
‚îú‚îÄ .dockerignore
‚îú‚îÄ .env.example
‚îú‚îÄ docker-compose.yml
‚îú‚îÄ docker-compose.override.yml
‚îú‚îÄ Caddyfile
‚îú‚îÄ prometheus.yml
‚îú‚îÄ monitoring/
‚îÇ  ‚îî‚îÄ rules.yml
‚îú‚îÄ scripts/
‚îÇ  ‚îú‚îÄ backup.sh
‚îÇ  ‚îî‚îÄ deploy.sh
‚îú‚îÄ blue-green-deploy.sh
‚îú‚îÄ renovate.json
‚îú‚îÄ terraform/
‚îÇ  ‚îî‚îÄ main.tf
‚îú‚îÄ sql/
‚îÇ  ‚îî‚îÄ init.sql
‚îú‚îÄ frontend/
‚îÇ  ‚îî‚îÄ global.css
‚îú‚îÄ services/
‚îÇ  ‚îú‚îÄ api/
‚îÇ  ‚îÇ  ‚îú‚îÄ Dockerfile
‚îÇ  ‚îÇ  ‚îú‚îÄ package.json
‚îÇ  ‚îÇ  ‚îú‚îÄ tsconfig.json
‚îÇ  ‚îÇ  ‚îú‚îÄ public/
‚îÇ  ‚îÇ  ‚îÇ  ‚îú‚îÄ theme.css
‚îÇ  ‚îÇ  ‚îÇ  ‚îú‚îÄ voice.html
‚îÇ  ‚îÇ  ‚îÇ  ‚îî‚îÄ brand/
‚îÇ  ‚îÇ  ‚îÇ     ‚îî‚îÄ logo-stefano.png  (placeholder ‚Äì wstaw swoje logo)
‚îÇ  ‚îÇ  ‚îî‚îÄ src/
‚îÇ  ‚îÇ     ‚îú‚îÄ index.ts
‚îÇ  ‚îÇ     ‚îú‚îÄ app.ts
‚îÇ  ‚îÇ     ‚îú‚îÄ routes.ts
‚îÇ  ‚îÇ     ‚îú‚îÄ logger.ts
‚îÇ  ‚îÇ     ‚îú‚îÄ metrics.ts
‚îÇ  ‚îÇ     ‚îú‚îÄ auth.ts
‚îÇ  ‚îÇ     ‚îú‚îÄ db.ts
‚îÇ  ‚îÇ     ‚îú‚îÄ sanitization.ts
‚îÇ  ‚îÇ     ‚îî‚îÄ types.ts
‚îÇ  ‚îú‚îÄ orchestrator/
‚îÇ  ‚îÇ  ‚îú‚îÄ Dockerfile
‚îÇ  ‚îÇ  ‚îú‚îÄ package.json
‚îÇ  ‚îÇ  ‚îú‚îÄ tsconfig.json
‚îÇ  ‚îÇ  ‚îî‚îÄ src/
‚îÇ  ‚îÇ     ‚îú‚îÄ index.ts
‚îÇ  ‚îÇ     ‚îî‚îÄ metrics.ts
‚îÇ  ‚îú‚îÄ connector-sb/
‚îÇ  ‚îÇ  ‚îú‚îÄ Dockerfile
‚îÇ  ‚îÇ  ‚îú‚îÄ package.json
‚îÇ  ‚îÇ  ‚îú‚îÄ tsconfig.json
‚îÇ  ‚îÇ  ‚îî‚îÄ src/
‚îÇ  ‚îÇ     ‚îú‚îÄ index.ts
‚îÇ  ‚îÇ     ‚îî‚îÄ health.ts
‚îÇ  ‚îî‚îÄ ml/
‚îÇ     ‚îú‚îÄ Dockerfile
‚îÇ     ‚îú‚îÄ requirements.txt
‚îÇ     ‚îú‚îÄ train.py
‚îÇ     ‚îî‚îÄ predict.py
‚îî‚îÄ .github/
   ‚îî‚îÄ workflows/
      ‚îî‚îÄ deploy.yml

üì¶ Pliki (kopiuj 1:1)
.dockerignore
node_modules
dist
coverage
*.log
.git
.env
.DS_Store
**/node_modules
**/dist
**/*.log

.env.example
# Domeny / TLS
DOMAIN=stefanogroup.pl
LETSENCRYPT_EMAIL=admin@stefanogroup.pl

# Postgres
POSTGRES_USER=stefano
POSTGRES_PASSWORD=stefano_password
POSTGRES_DB=stefano

# Grafana (has≈Ça przyk≈Çadowe ‚Äì zmie≈Ñ)
GF_ADMIN_PASSWORD=adminpass
GF_BASIC_AUTH_USER=admin
GF_BASIC_AUTH_PASS=changeme

# API / Aplikacja
APP_PORT=5000
NODE_ENV=production

# Redis
REDIS_HOST=redis
REDIS_PORT=6379

# Stripe (karta/BLIK/P24)
STRIPE_SECRET=sk_test_xxx
STRIPE_PUBLISHABLE=pk_test_xxx

# DeepSeek przez OpenRouter (zalecane)
OPENROUTER_API_KEY=or_xxx
# (opcjonalnie) Direct DeepSeek:
DEEPSEEK_API_KEY=

# Prometheus exporters
POSTGRES_EXPORTER_USER=stefano
POSTGRES_EXPORTER_PASSWORD=stefano_password

# Connector Small Business Bistro ‚Äì folder hosta (Windows)
SB_HOST_DIR=C:/SB/Exchange

docker-compose.yml
version: '3.8'

networks:
  stefano_net:
    driver: bridge

volumes:
  db_data:
  redis_data:
  caddy_data:
  caddy_config:
  prom_data:
  grafana_data:

services:
  db:
    image: postgres:15-alpine
    networks: [stefano_net]
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
      shared_preload_libraries: pg_stat_statements,pg_cron
      cron.database_name: ${POSTGRES_DB}
    volumes:
      - db_data:/var/lib/postgresql/data
      - ./sql/init.sql:/docker-entrypoint-initdb.d/00-init.sql:ro
    healthcheck:
      test: ["CMD-SHELL","pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s
    restart: unless-stopped

  pgbouncer:
    image: edoburu/pgbouncer
    networks: [stefano_net]
    depends_on:
      db:
        condition: service_healthy
    environment:
      DB_HOST: db
      DB_USER: ${POSTGRES_USER}
      DB_PASSWORD: ${POSTGRES_PASSWORD}
      DB_NAME: ${POSTGRES_DB}
      POOL_MODE: transaction
      MAX_CLIENT_CONN: 200
      DEFAULT_POOL_SIZE: 20
    healthcheck:
      test: ["CMD", "pg_isready", "-h", "localhost", "-p", "6432", "-U", "${POSTGRES_USER}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    networks: [stefano_net]
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 10s
    restart: unless-stopped

  api:
    build:
      context: ./services/api
      dockerfile: Dockerfile
    networks: [stefano_net]
    depends_on:
      pgbouncer:
        condition: service_healthy
      redis:
        condition: service_healthy
    env_file: .env
    environment:
      NODE_ENV: production
      APP_PORT: 5000
      DATABASE_URL: postgres://${POSTGRES_USER}:${POSTGRES_PASSWORD}@pgbouncer:6432/${POSTGRES_DB}?pgbouncer=true
      REDIS_HOST: redis
      STRIPE_SECRET: ${STRIPE_SECRET}
      STRIPE_PUBLISHABLE: ${STRIPE_PUBLISHABLE}
      OPENROUTER_API_KEY: ${OPENROUTER_API_KEY}
      DEEPSEEK_API_KEY: ${DEEPSEEK_API_KEY}
    expose:
      - "5000"
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://localhost:5000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped

  orchestrator:
    build: ./services/orchestrator
    networks: [stefano_net]
    depends_on:
      api:
        condition: service_healthy
      redis:
        condition: service_healthy
      pgbouncer:
        condition: service_healthy
    env_file: .env
    environment:
      NODE_ENV: production
      DATABASE_URL: postgres://${POSTGRES_USER}:${POSTGRES_PASSWORD}@pgbouncer:6432/${POSTGRES_DB}?pgbouncer=true
      REDIS_HOST: redis
      APP_PORT: 5001
    expose:
      - "5001"
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://localhost:5001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped

  connector-sb:
    build: ./services/connector-sb
    networks: [stefano_net]
    depends_on:
      pgbouncer:
        condition: service_healthy
    env_file: .env
    environment:
      NODE_ENV: production
      DATABASE_URL: postgres://${POSTGRES_USER}:${POSTGRES_PASSWORD}@pgbouncer:6432/${POSTGRES_DB}?pgbouncer=true
      SB_MOUNT_DIR: /bridge
    volumes:
      - ${SB_HOST_DIR:-/tmp/sb-bridge}:/bridge
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://localhost:7001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    restart: unless-stopped

  ml:
    build: ./services/ml
    networks: [stefano_net]
    depends_on:
      pgbouncer:
        condition: service_healthy
    env_file: .env
    environment:
      DATABASE_URL: postgres://${POSTGRES_USER}:${POSTGRES_PASSWORD}@pgbouncer:6432/${POSTGRES_DB}?pgbouncer=true
    command: python train.py
    healthcheck:
      test: ["CMD", "python", "--version"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 10s
    restart: unless-stopped

  caddy:
    image: caddy:2-alpine
    networks: [stefano_net]
    depends_on:
      - api
      - orchestrator
    ports:
      - "80:80"
      - "443:443"
    environment:
      DOMAIN: ${DOMAIN}
      LETSENCRYPT_EMAIL: ${LETSENCRYPT_EMAIL}
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - ./services/api/public:/usr/share/app/public:ro
      - caddy_data:/data
      - caddy_config:/config
    healthcheck:
      test: ["CMD", "caddy", "version"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 20s
    restart: unless-stopped

  prometheus:
    image: prom/prometheus
    networks: [stefano_net]
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./monitoring/rules.yml:/etc/prometheus/rules.yml:ro
      - prom_data:/prometheus
    command: ['--config.file=/etc/prometheus/prometheus.yml']
    healthcheck:
      test: ["CMD", "wget", "--spider", "localhost:9090/-/healthy"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    restart: unless-stopped

  grafana:
    image: grafana/grafana
    networks: [stefano_net]
    ports:
      - "3001:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=${GF_ADMIN_PASSWORD}
    volumes:
      - grafana_data:/var/lib/grafana
    healthcheck:
      test: ["CMD", "wget", "--spider", "localhost:3000/login"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    restart: unless-stopped

  node_exporter:
    image: quay.io/prometheus/node-exporter:latest
    networks: [stefano_net]
    command:
      - '--path.rootfs=/host'
    pid: "host"
    volumes:
      - '/:/host:ro,rslave'
    restart: unless-stopped

  redis_exporter:
    image: bitnami/redis-exporter:latest
    networks: [stefano_net]
    environment:
      REDIS_ADDR: redis:6379
    restart: unless-stopped

  postgres_exporter:
    image: quay.io/prometheuscommunity/postgres-exporter
    networks: [stefano_net]
    environment:
      DATA_SOURCE_NAME: postgresql://${POSTGRES_EXPORTER_USER}:${POSTGRES_EXPORTER_PASSWORD}@db:5432/${POSTGRES_DB}?sslmode=disable
    restart: unless-stopped

docker-compose.override.yml (dev)
version: '3.8'
services:
  api:
    environment:
      NODE_ENV: development
    volumes:
      - ./services/api:/app
      - /app/node_modules
    command: sh -c "npm i && npm run build && npm start"

  orchestrator:
    environment:
      NODE_ENV: development
    volumes:
      - ./services/orchestrator:/app
      - /app/node_modules

  connector-sb:
    environment:
      NODE_ENV: development
    volumes:
      - ./services/connector-sb:/app
      - /app/node_modules

Caddyfile
{
  email {$LETSENCRYPT_EMAIL}
  acme_ca https://acme-v02.api.letsencrypt.org/directory
}

{$DOMAIN} {
  encode zstd gzip

  root * /usr/share/app/public
  file_server {
    precompressed br gzip
  }

  handle_path /api/* {
    reverse_proxy api:5000
  }

  handle_path /orchestrator/* {
    reverse_proxy orchestrator:5001
  }

  header {
    Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    X-Content-Type-Options "nosniff"
    X-Frame-Options "DENY"
    Referrer-Policy "strict-origin-when-cross-origin"
    Permissions-Policy "accelerometer=(), camera=(), geolocation=(), gyroscope=(), magnetometer=(), microphone=(), payment=(), usb=(), sync-xhr=()"
    Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' https://js.stripe.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src https://fonts.gstatic.com; img-src 'self' data: https://*; connect-src 'self' wss: https://api.stripe.com https://openrouter.ai; frame-src https://js.stripe.com https://hooks.stripe.com"
  }

  @sensitive {
    path /api/admin/* /api/privacy/* /bull-board/*
  }
  request_body @sensitive {
    max_size 1MB
  }

  tls {
    protocols tls1.2 tls1.3
  }

  log {
    output stdout
    format console
  }
}

prometheus.yml
global:
  scrape_interval: 15s

rule_files:
  - /etc/prometheus/rules.yml

scrape_configs:
  - job_name: 'api'
    metrics_path: /metrics
    static_configs:
      - targets: ['api:5000']

  - job_name: 'orchestrator'
    metrics_path: /metrics
    static_configs:
      - targets: ['orchestrator:5001']

  - job_name: 'postgres'
    static_configs:
      - targets: ['postgres_exporter:9187']

  - job_name: 'redis'
    static_configs:
      - targets: ['redis_exporter:9121']

  - job_name: 'node'
    static_configs:
      - targets: ['node_exporter:9100']

monitoring/rules.yml
groups:
  - name: Stefano Alerts
    rules:
      - alert: HighLatency
        expr: histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket[5m])) by (le)) > 1
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: Wysoka latencja (p95 > 1s)
          description: Sprawd≈∫ API, DB lub sieƒá.

      - alert: HighErrorRate
        expr: sum(rate(http_requests_total{status=~"5.."}[5m])) / sum(rate(http_requests_total[5m])) > 0.01
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: Wysoki odsetek b≈Çƒôd√≥w 5xx (>1%)
          description: Sprawd≈∫ logi, Sentry, kod, DB.

      - alert: QueueBacklog
        expr: bullmq_jobs_waiting > 10
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: Kolejka backlog >10
          description: Sprawd≈∫ worker, DLQ.

      - alert: DiskUsageHigh
        expr: (1 - node_filesystem_avail_bytes / node_filesystem_size_bytes) * 100 > 80
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: Dysk >80%
          description: Czyszczenie lub rozszerz.

      - alert: MLDrift
        expr: ml_drift_p_value < 0.05
        for: 1h
        labels:
          severity: page
        annotations:
          summary: Detekcja dryfu danych ML
          description: Sprawd≈∫ dane, retrain manualnie.

      - alert: QCFailRateHigh
        expr: sum(qc_fails) / sum(qc_total) > 0.01
        for: 1h
        labels:
          severity: critical
        annotations:
          summary: QC fail rate >1%
          description: Sprawd≈∫ render/asset pipeline.

scripts/backup.sh
#!/bin/bash
set -euo pipefail

STAMP=$(date +%Y%m%d_%H%M%S)
FILE="backup_${STAMP}.sql"

pg_dump "$DATABASE_URL" > "$FILE"

if [[ -n "${R2_ACCOUNT_ID:-}" ]]; then
  aws s3 cp "$FILE" "s3://stefano-backups/" \
    --endpoint-url="https://${R2_ACCOUNT_ID}.r2.cloudflarestorage.com"
fi

echo "Backup done: $FILE"

scripts/deploy.sh
#!/bin/bash
set -euo pipefail

docker compose down
docker compose build --pull
docker compose up -d
docker system prune -f

blue-green-deploy.sh
#!/bin/bash
set -euo pipefail

CURRENT=blue
NEW=green

if [[ -f /opt/stefano/current ]]; then
  CURRENT=$(cat /opt/stefano/current)
  if [[ "$CURRENT" == "blue" ]]; then NEW="green"; else NEW="blue"; fi
fi

cd "/opt/stefano/$NEW"
git pull
docker compose -p "stefano-$NEW" -f docker-compose.yml up -d --build

sleep 30

curl -f "https://stefano-$NEW.example.com/api/health"

echo "$NEW" > /opt/stefano/current

docker compose -p "stefano-$CURRENT" down
docker image prune -f

renovate.json
{
  "extends": ["config:base"],
  "schedule": ["every weekend"],
  "prConcurrentLimit": 3,
  "prHourlyLimit": 1,
  "labels": ["dependencies"],
  "packageRules": [
    {
      "matchUpdateTypes": ["minor", "patch"],
      "automerge": true
    }
  ]
}

terraform/main.tf
terraform {
  required_version = ">= 1.6.0"
  required_providers {
    hcloud = {
      source  = "hetznercloud/hcloud"
      version = "~> 1.47"
    }
    aws = {
      source  = "hashicorp/aws"
      version = "~> 5.54"
    }
  }
}

variable "hcloud_token" {}
variable "ssh_key_name" {}
variable "server_name" { default = "stefano-api" }
variable "location" { default = "fsn1" }
variable "server_type" { default = "cx41" }
variable "image" { default = "ubuntu-24.04" }
variable "admin_ips" {
  type    = list(string)
  default = []
}

# Cloudflare R2 via AWS provider (set AWS_ACCESS_KEY_ID / AWS_SECRET_ACCESS_KEY and endpoint in env)
provider "aws" {
  region                      = "auto"
  skip_credentials_validation = false
  skip_requesting_account_id  = true
  s3_force_path_style         = true
  endpoints {
    s3 = "https://<your_account_id>.r2.cloudflarestorage.com"
  }
}

provider "hcloud" {
  token = var.hcloud_token
}

resource "hcloud_ssh_key" "main" {
  name       = var.ssh_key_name
  public_key = file("~/.ssh/id_ed25519.pub")
}

resource "hcloud_firewall" "api" {
  name = "stefano-api-fw"
  rule {
    direction  = "in"
    protocol   = "tcp"
    port       = "22"
    source_ips = var.admin_ips
  }
  rule {
    direction  = "in"
    protocol   = "tcp"
    port       = "80"
    source_ips = ["0.0.0.0/0", "::/0"]
  }
  rule {
    direction  = "in"
    protocol   = "tcp"
    port       = "443"
    source_ips = ["0.0.0.0/0", "::/0"]
  }
}

resource "hcloud_server" "stefano_api" {
  name        = var.server_name
  image       = var.image
  server_type = var.server_type
  location    = var.location
  ssh_keys    = [hcloud_ssh_key.main.name]
  firewall_ids = [hcloud_firewall.api.id]
}

resource "hcloud_firewall_attachment" "api" {
  firewall_id = hcloud_firewall.api.id
  server_ids  = [hcloud_server.stefano_api.id]
}

resource "aws_s3_bucket" "stefano_media" {
  bucket = "stefano-media"
}

output "server_ip" {
  value = hcloud_server.stefano_api.ipv4_address
}

output "r2_bucket" {
  value = aws_s3_bucket.stefano_media.bucket
}

sql/init.sql
-- Users (example)
CREATE TABLE IF NOT EXISTS users (
  id SERIAL PRIMARY KEY,
  email TEXT UNIQUE NOT NULL,
  password_hash TEXT NOT NULL,
  role TEXT DEFAULT 'user',
  created_at TIMESTAMP DEFAULT now()
);

-- Customers
CREATE TABLE IF NOT EXISTS customers (
  id SERIAL PRIMARY KEY,
  email TEXT UNIQUE,
  name TEXT,
  loyalty_points INTEGER DEFAULT 0,
  created_at DATE DEFAULT CURRENT_DATE
) PARTITION BY RANGE (created_at);

-- 2025 partition (improve partitioning)
CREATE TABLE IF NOT EXISTS customers_2025 PARTITION OF customers
FOR VALUES FROM ('2025-01-01') TO ('2026-01-01');

-- Orders
CREATE TABLE IF NOT EXISTS orders (
  id SERIAL PRIMARY KEY,
  customer_id INTEGER REFERENCES customers(id),
  total_cents INTEGER NOT NULL,
  status TEXT CHECK (status IN ('new','paid','preparing','ready','delivered','cancelled')) DEFAULT 'new',
  payment_ref TEXT,
  created_at TIMESTAMP DEFAULT now()
);

-- Order items
CREATE TABLE IF NOT EXISTS order_items (
  id SERIAL PRIMARY KEY,
  order_id INTEGER REFERENCES orders(id) ON DELETE CASCADE,
  product_id INTEGER,
  name TEXT,
  qty INTEGER NOT NULL,
  price_cents INTEGER NOT NULL
);

-- Products
CREATE TABLE IF NOT EXISTS products (
  id SERIAL PRIMARY KEY,
  name TEXT NOT NULL,
  price_cents INTEGER NOT NULL,
  category TEXT,
  active BOOLEAN DEFAULT TRUE
);

-- Reviews (GB Profile / FB etc)
CREATE TABLE IF NOT EXISTS reviews (
  id SERIAL PRIMARY KEY,
  source TEXT,
  author TEXT,
  rating INTEGER CHECK (rating BETWEEN 1 AND 5),
  content TEXT,
  created_at TIMESTAMP DEFAULT now()
);

-- Posts (scheduled social)
CREATE TABLE IF NOT EXISTS posts (
  id SERIAL PRIMARY KEY,
  platform TEXT,
  content TEXT,
  media_url TEXT,
  status TEXT CHECK (status IN ('draft','scheduled','published','failed')) DEFAULT 'draft',
  scheduled_at TIMESTAMP
);

-- API keys (encrypted/obfuscated externally)
CREATE TABLE IF NOT EXISTS api_keys (
  id SERIAL PRIMARY KEY,
  name TEXT UNIQUE NOT NULL,
  value_enc TEXT NOT NULL,
  created_at TIMESTAMP DEFAULT now()
);

-- Audit logs (partitioned by date)
CREATE TABLE IF NOT EXISTS audit_logs (
  id SERIAL PRIMARY KEY,
  user_id INTEGER REFERENCES users(id) ON DELETE SET NULL,
  action TEXT,
  payload JSONB,
  created_at DATE DEFAULT CURRENT_DATE
) PARTITION BY RANGE (created_at);

CREATE TABLE IF NOT EXISTS audit_logs_2025 PARTITION OF audit_logs
FOR VALUES FROM ('2025-01-01') TO ('2026-01-01');

-- Refresh tokens (missing table)
CREATE TABLE IF NOT EXISTS refresh_tokens (
  id SERIAL PRIMARY KEY,
  user_id INTEGER REFERENCES users(id) ON DELETE CASCADE,
  token TEXT NOT NULL UNIQUE,
  expires_at TIMESTAMP NOT NULL,
  created_at TIMESTAMP DEFAULT now()
);

-- Loyalty transactions (missing table)
CREATE TABLE IF NOT EXISTS loyalty_transactions (
  id SERIAL PRIMARY KEY,
  customer_id INTEGER REFERENCES customers(id),
  points INTEGER NOT NULL,
  type TEXT CHECK (type IN ('earn', 'spend')),
  order_id INTEGER REFERENCES orders(id),
  created_at TIMESTAMP DEFAULT now()
);

-- Outbox & Dead Letter for connector-sb
CREATE TABLE IF NOT EXISTS outbox (
  id BIGSERIAL PRIMARY KEY,
  event_type TEXT NOT NULL,
  payload JSONB NOT NULL,
  retries INTEGER DEFAULT 0,
  status TEXT CHECK (status IN ('pending','sent','failed')) DEFAULT 'pending',
  created_at TIMESTAMP DEFAULT now()
);

CREATE TABLE IF NOT EXISTS dead_letter (
  id BIGSERIAL PRIMARY KEY,
  event_type TEXT NOT NULL,
  payload JSONB NOT NULL,
  error TEXT,
  created_at TIMESTAMP DEFAULT now()
);

frontend/global.css
/* Responsive padding + accessibility contrast */
@media (max-width: 768px) {
  .container { padding: 0 1rem; }
  header { flex-direction: column; gap: 1rem; }
}

/* Primary CTA */
.primary-button {
  background-color: var(--stefano-red, hsl(4, 100%, 59%));
  color: #fff;
  padding: 12px 24px;
  border-radius: var(--radius, 12px);
}
.primary-button:hover {
  background-color: hsl(4, 100%, 45%);
}

services/api
services/api/Dockerfile
FROM node:20-alpine
WORKDIR /app

# Install curl for healthcheck
RUN apk add --no-cache curl

# Non-root
RUN addgroup -g 1001 -S nodejs && adduser -S nodeapp -u 1001

COPY package.json tsconfig.json ./
RUN npm i

COPY public ./public
COPY src ./src

USER nodeapp
EXPOSE 5000

HEALTHCHECK --interval=30s --timeout=10s --retries=3 --start-period=40s \
  CMD curl -fsS http://localhost:5000/api/health || exit 1

CMD ["npm","run","start"]

services/api/package.json
{
  "name": "stefano-api",
  "version": "1.0.0",
  "type": "module",
  "scripts": {
    "build": "tsc",
    "start": "node dist/index.js",
    "dev": "ts-node-esm src/index.ts",
    "build:prod": "npm ci --only=production && tsc",
    "start:prod": "node dist/index.js"
  },
  "dependencies": {
    "@types/express": "^4.17.21",
    "@types/node": "^20.12.12",
    "cors": "^2.8.5",
    "dotenv": "^16.4.5",
    "express": "^4.19.2",
    "express-rate-limit": "^7.2.0",
    "helmet": "^7.1.0",
    "node-cache": "^5.1.2",
    "pg": "^8.12.0",
    "pino": "^9.0.0",
    "pino-http": "^10.0.0",
    "prom-client": "^15.1.0",
    "sanitize-html": "^2.13.0",
    "stripe": "^15.10.0",
    "zod": "^3.23.8"
  },
  "devDependencies": {
    "ts-node": "^10.9.2",
    "typescript": "^5.5.4"
  }
}

services/api/tsconfig.json
{
  "compilerOptions": {
    "target": "ES2022",
    "lib": ["ES2022"],
    "module": "ES2022",
    "moduleResolution": "Node",
    "outDir": "dist",
    "rootDir": "src",
    "esModuleInterop": true,
    "strict": true,
    "resolveJsonModule": true,
    "skipLibCheck": true
  },
  "include": ["src"]
}

services/api/public/theme.css
:root{
  --stefano-gold:#D4AF37;
  --stefano-red:#FF3B30;
  --bg:#0E0E10; --card:#141416; --muted:#2A2A2D; --line:#27272a;
  --text:#F7F7F7; --text-muted:#B9B9BD; --radius:16px;
}
html,body{background:var(--bg);color:var(--text);margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
.card{background:var(--card);border:1px solid var(--line);border-radius:20px;box-shadow:0 8px 24px rgba(0,0,0,.35);padding:1rem}
.btn{display:inline-flex;align-items:center;gap:.6rem;padding:.9rem 1.4rem;border-radius:12px;font-weight:700}
.btn-primary{background:var(--stefano-red);color:#fff}
.btn-gold{background:linear-gradient(180deg,#FFE089,var(--stefano-gold) 60%,#9C7A1F);color:#000}
.stefano-gold-text{background:linear-gradient(180deg,#FFD86A 0%, var(--stefano-gold) 55%, #8F6B1D 100%);-webkit-background-clip:text;background-clip:text;color:transparent}
.hero{position:relative;border-radius:20px;overflow:hidden;background:center/cover no-repeat url('/img/hero-pizza.jpg')}
.hero::after{content:"";position:absolute;inset:0;background:radial-gradient(60% 60% at 50% 30%, rgba(0,0,0,.00) 0%, rgba(0,0,0,.65) 60%), linear-gradient(180deg, rgba(0,0,0,.25), rgba(0,0,0,.75))}
.hero .inner{position:relative;z-index:2;padding:6rem 2rem;text-align:center}

services/api/public/voice.html
<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <title>Stefano ‚Äî G≈Çosowe zamawianie</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/theme.css" />
</head>
<body>
  <header class="card" style="display:flex;align-items:center;justify-content:space-between;gap:16px;margin:12px;">
    <div style="display:flex;align-items:center;gap:12px">
      <img src="/brand/logo-stefano.png" alt="STEFANO" height="36"/>
      <nav style="display:flex;gap:12px;color:#EDEDED">
        <a href="#" style="color:inherit;text-decoration:none">O nas</a>
        <a href="#" style="color:inherit;text-decoration:none">Menu</a>
        <a href="#order" class="btn btn-primary">Zam√≥w</a>
      </nav>
    </div>
    <div><a class="btn btn-gold">Program lojalno≈õciowy</a></div>
  </header>

  <section class="hero" style="margin:12px;">
    <div class="inner">
      <h1 class="stefano-gold-text" style="font-size:64px;font-weight:900;letter-spacing:.04em;">STEFANO</h1>
      <p style="opacity:.85">Delicious Pizza & Family Chicken King</p>
      <div style="display:flex;gap:12px;justify-content:center;margin-top:10px">
        <button id="rec" class="btn btn-primary">üé§ M√≥w ‚Äî zamawiaj</button>
        <a class="btn btn-gold" href="#order">Zobacz menu</a>
      </div>
    </div>
  </section>

  <main class="card" style="margin:12px;">
    <h2 style="margin-top:0">Asystent g≈Çosowy</h2>
    <div id="log" style="min-height:140px;white-space:pre-wrap"></div>
  </main>

  <script>
    const log = (t)=>{

Powiedzia≈Çe≈õ(-a≈õ):
TO CA≈ÅO≈öƒÜ?
ChatGPT powiedzia≈Ç:
My≈õla≈Ç przez 12s

Tak ‚Äî z punktu widzenia produkcji to jest komplet. üì¶
Nie musisz wracaƒá do wcze≈õniejszych wƒÖtk√≥w. Dla pewno≈õci masz poni≈ºej kr√≥tkƒÖ listƒô kontrolnƒÖ (co dok≈Çadnie powinno byƒá w repo po Twojej stronie). Je≈õli ka≈ºdy punkt u Ciebie siƒô zgadza, to ‚Äûmamy ca≈Ço≈õƒá‚Äù.

Lista kontrolna (prod-ready)

SQL (sql/init.sql)

refresh_tokens, loyalty_transactions + partycje customers_2025, audit_logs_2025.

Terraform (terraform/main.tf + outputs)

hcloud_firewall_attachment.api do serwera API.

Outputy: server_ip, r2_bucket.

(Rozszerzenia, je≈õli doda≈Çe≈õ): Cloudflare WAF, R2, zmienne admin_ips.

ML (services/ml/train.py)

Twardsza walidacja (len(df) < 50, filtr outlier√≥w engagement <= 1_000_000).

Try/except + logger.error i notify_slack(...).

Frontend CSS (services/api/public/global.css lub public/theme.css)

Media queries ‚â§768px, poprawiony kontrast, .primary-button:hover itp.

(Skin Stefano: ciemny + z≈Çoto + czerwone CTA ‚Äì je≈õli wstawi≈Çe≈õ theme.css).

BrakujƒÖce pliki

services/api/src/types.ts (MarketingJob, Customer).

scripts/backup.sh (dump ‚Üí R2).

docker-compose.override.yml (dev: hot-reload).

Security

services/api/src/auth.ts: rate limit login (max: 5 / 15 min).

services/api/src/db.ts: Pool z max=20, timeouts, ssl on prod.

services/api/src/app.ts: helmet(...) + CSP + pino-http.

services/api/src/index.ts: integracja Sentry (DSN z .env).

services/api/src/sanitization.ts: sanitizacja payload√≥w + app.use(...).

Optymalizacje NPM

services/api/package.json: "build:prod", "start:prod".

Compose (prod)

docker-compose.yml: us≈Çugi db, pgbouncer, redis, api, orchestrator, connector-sb, ml, caddy, prometheus, grafana (+ healthchecki, restart: unless-stopped).

API startuje bez ‚Äûnpm i na starcie‚Äù w produkcji (je≈õli u≈ºywasz build stage) lub zgodnie z TwojƒÖ wersjƒÖ (zosta≈Ço jak w Twoim pliku).

Caddyfile: reverse-proxy, HSTS, CSP, headers, /api/* ‚Üí api:5000.

Monitoring

prometheus.yml + /etc/prometheus/rules.yml (Alerty: p95, 5xx, kolejka, dysk, ML drift, QC).

grafana z provisioning (has≈Ço admina z .env).

Sentry (self-hosted opcjonalnie)

Serwis sentry (je≈õli w≈ÇƒÖczy≈Çe≈õ) lub tylko DSN do chmurowego Sentry.

SB Bistro Connector

services/connector-sb + montowanie SB_HOST_DIR:/bridge.

Outbox + DLQ + endpoint POST /api/admin/requeue.

Orchestrator

services/orchestrator (cron: social, GBP opinie, SEO audit, CRM).

Tokeny przez .env (Meta/GBP/GA4 ‚Äì na p√≥≈∫niej, je≈õli chcesz).

CI/CD

.github/workflows/deploy.yml (checkout, test, CodeQL, deploy via SSH, smoke test, Slack).

renovate.json (auto-update).

Trivy SBOM (je≈õli trzymasz skrypt kroku).

Deployment skrypty

deploy.sh (compose down/build/up/prune).

blue-green-deploy.sh (zero-downtime; current marker, smoke test).

Backup

scripts/backup.sh + crontab 0 3 * * * (dump ‚Üí R2).

Szybkie sanity-check (2 min)

.env uzupe≈Çniony (DB, DOMAIN, LETSENCRYPT_EMAIL, DeepSeek/OpenRouter, Stripe, R2, SENTRY_DSN).

docker compose up -d --build przechodzi bez b≈Çƒôd√≥w.

curl -f https://twoja-domena/api/health ‚Üí 200.

Panel Grafany dzia≈Ça (:3001), Prometheus :9090 healthy.

W logach API brak b≈Çƒôd√≥w Sentry/DB, pgbouncer healthy.

W C:\SB\Exchange\outgoing (Windows) pojawiajƒÖ siƒô pliki zam√≥wie≈Ñ po POST na /api/orders (je≈õli u≈ºywasz connectora).

Je≈õli powy≈ºsze punkty sƒÖ u Ciebie na miejscu, to tak ‚Äî to jest ca≈Ço≈õƒá gotowa na produkcjƒô